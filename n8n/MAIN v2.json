{
  "name": "MAIN v2",
  "nodes": [
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.from.id }}",
        "text": "={{ \n$json.text_response\n  // 1. –ú–µ–Ω—è–µ–º <br> –Ω–∞ –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏ (Telegram –∏—Ö –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç)\n  .replace(/<br\\s*\\/?>/gi, '\\n')\n  \n  // 2. –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤—Å–µ –∑–Ω–∞–∫–∏ \"<\" –≤ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ç–µ–∫—Å—Ç \"&lt;\",\n  // –ö–†–û–ú–ï —Ç–µ—Ö —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ —ç—Ç–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–π —Ç–µ–≥ (–Ω–∞–ø—Ä–∏–º–µ—Ä <b>, </i>, </a>)\n  .replace(/<(?!\\/?(b|i|u|s|pre|code|a)(>|\\s))/gi, '&lt;') \n}}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1552,
        32
      ],
      "id": "d321122b-93da-491c-83b2-044d2aa15977",
      "name": "message for AI agent",
      "webhookId": "a5019b38-550d-498b-9997-cd37605484b4",
      "credentials": {
        "telegramApi": {
          "id": "MC57N6YjUFPSjXve",
          "name": "bot_ivan"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2,
      "position": [
        -2384,
        320
      ],
      "id": "158c449f-5a47-4388-9b55-7436cabd1599",
      "name": "Transcribe a recording",
      "credentials": {
        "openAiApi": {
          "id": "AqF0QtsuHggFTOVX",
          "name": "my openAI"
        }
      }
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $('Telegram Trigger').item.json.message.voice.file_id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2544,
        320
      ],
      "id": "5b532386-b797-4e3a-9f03-c8d4f1c3f0de",
      "name": "Get a file",
      "webhookId": "44c80709-3457-4b22-ae06-616657481f35",
      "credentials": {
        "telegramApi": {
          "id": "MC57N6YjUFPSjXve",
          "name": "bot_ivan"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Telegram Trigger').item.json.message.text }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "id": "56ce6495-0633-443e-8f68-410829bb5a98"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "2a3ff28a-7360-42d6-a9e4-32eafa69bf23",
                    "leftValue": "",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "voice"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -2768,
        160
      ],
      "id": "c362d945-17b2-47be-9faa-64b22411ff2d",
      "name": "routher"
    },
    {
      "parameters": {
        "resource": "chat",
        "operation": "member",
        "chatId": "-1002504147240",
        "userId": "={{ $json.user_id }}"
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3392,
        464
      ],
      "id": "10fd8832-1d91-45b8-b3c1-1d4d557667d6",
      "name": "check follower",
      "webhookId": "b07721fd-a7f0-4f54-9f2a-040c877699d1",
      "credentials": {
        "telegramApi": {
          "id": "MC57N6YjUFPSjXve",
          "name": "bot_ivan"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const tgData = $('Telegram Trigger').first().json;\n// –ó–∞—â–∏—Ç–∞ –æ—Ç null, –µ—Å–ª–∏ –ø—Ä–∏–¥–µ—Ç —Å—Ç–∏–∫–µ—Ä –∏–ª–∏ –≤–æ–π—Å –±–µ–∑ —Ç–µ–∫—Å—Ç–∞\nconst text = tgData.message?.text || tgData.message?.caption || \"\"; \n\nlet detectedLang = 'en'; // –î–µ—Ñ–æ–ª—Ç (Latin)\n\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ê—Ä–∞–±—Å–∫–∏–π (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Ññ1, —Ç–∞–∫ –∫–∞–∫ RTL –≤–µ—Ä—Å—Ç–∫–∞ –º–æ–∂–µ—Ç –ª–æ–º–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)\n// –î–∏–∞–ø–∞–∑–æ–Ω –≤–∫–ª—é—á–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∞—Ä–∞–±—Å–∫–∏–π –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è\nconst arabicRegex = /[\\u0600-\\u06FF\\u0750-\\u077F]/;\n\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ö–∏—Ä–∏–ª–ª–∏—Ü—É\nconst cyrillicRegex = /[\\u0400-\\u04FF]/;\n\nif (arabicRegex.test(text)) {\n  detectedLang = 'ar';\n} else if (cyrillicRegex.test(text)) {\n  detectedLang = 'ru';\n}\n// –ï—Å–ª–∏ –Ω–∏ —Ç–æ, –Ω–∏ –¥—Ä—É–≥–æ–µ ‚Äî –æ—Å—Ç–∞–µ—Ç—Å—è 'en'\n\nreturn {\n  user_id: tgData.message?.from?.id?.toString() || null,\n  username: tgData.message?.from?.username || \"unknown\",\n  message_text: text,\n  chat_id: tgData.message?.chat?.id,\n  language: detectedLang \n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3536,
        464
      ],
      "id": "6471a697-5cbd-42a5-90ae-6feca134b5a6",
      "name": "formating"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "<b>RU:</b>\n–ß—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞, –ø–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª: https://t.me/ivanfit_health\n\n<b>EN:</b>\nTo use the bot, please subscribe to the channel: https://t.me/ivanfit_health\n\n<b>AR:</b>\nŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®Ÿàÿ™ÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÅŸä ÿßŸÑŸÇŸÜÿßÿ©: https://t.me/ivanfit_health",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2768,
        464
      ],
      "id": "283d6caf-a6d3-4cb9-89e4-fec8de47a6ea",
      "name": "message menu",
      "webhookId": "e2bc9431-376c-4477-9b31-8dd003c637e0",
      "credentials": {
        "telegramApi": {
          "id": "MC57N6YjUFPSjXve",
          "name": "bot_ivan"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "859665c2-a0b5-4146-84ce-66085a9bf830",
              "leftValue": "={{ $json.is_subscribed }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3104,
        272
      ],
      "id": "0212afd3-cb9c-419e-b5c4-a90195fb3d9b",
      "name": "If"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "86257584-7cfe-4e0c-a813-665e84147f95",
                    "leftValue": "={{ $json.route_type }}",
                    "rightValue": "conversation",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "conversation"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b8aa51a2-2ec6-4895-a7bc-ed9c2f281cc9",
                    "leftValue": "={{ $json.route_type }}",
                    "rightValue": "generate",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "generate"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -1776,
        144
      ],
      "id": "d6a7ca93-673b-46d2-a901-1f7607730a5a",
      "name": "Switch"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.text }}",
        "options": {
          "systemMessage": "=# ROLE\nYou are Ivan, a friendly and tactful AI nutrition consultant. Your communication style is warm, supportive, light, and positive. You address the user informally (like a good acquaintance) but always respectfully.\n\nYou use emojis (üòä, ‚ú®, üçè, üëã) to create a cozy atmosphere, but moderately. Your main goal is to help the user become healthier and happier, regardless of their current shape. Avoid slang like \"bro\", \"bulking\", \"cutting\" unless the user uses it first; prefer neutral, kind wording.\n\n# CRITICAL LANGUAGE RULE (Very important)\nAlways reply in the SAME language as the user's LAST message.\n- If the user writes in English ‚Üí reply in English.\n- If the user writes in Russian ‚Üí reply in Russian.\n- If the user writes in Spanish ‚Üí reply in Spanish.\nThis applies to ALL languages. Do not mention this rule to the user. Just follow it.\n\n# OBJECTIVE\nCarefully collect user data required to calculate nutrition targets. Keep the conversation simple and clear. Do not overload the user with complicated terms.\n\n# REQUIRED DATA (What you must collect)\n1. sex (male/female)\n2. weight (kg, number) ‚Äî if the weight looks unrealistic, politely double-check.\n3. height (cm, number)\n4. age (years, number)\n5. activity_level (activity level). Interpret user answers as:\n   - sedentary (desk job, little movement)\n   - light (walks, light activity)\n   - moderate (workouts 3‚Äì4 times/week)\n   - high (active almost every day)\n   - extreme (pro athlete, heavy physical job)\n6. goal (goal). Interpret as:\n   - weight_loss (lose weight)\n   - maintenance (maintain)\n   - muscle_gain (gain muscle)\n7. allergies_and_preferences (allergies + foods the user avoids)\n\n# LOGIC & RULES\n1. Step 1 (Data collection): Ask 1‚Äì2 questions at a time. Do NOT send long lists of questions.\n   Example: \"Hi! Glad to see you üëã First, tell me: are you male or female? And how old are you?\"\n2. Step 2 (Validation): If numbers look strange (weight 10 kg, age 150), react gently with light humor:\n   \"Wow, 10 kg? That looks like a typo üòä Could you confirm your real weight?\"\n3. Step 3 (Off-topic handling): If the user goes off-topic, politely bring them back:\n   \"Interesting! But let's finish your nutrition plan first so I can help faster ‚ú® What is your height?\"\n4. Step 4 (Confirmation): When ALL required data is collected, show it as a neat list and ask:\n   \"Please confirm: did I get everything right?\"\n   - If the user says \"Yes / Correct\" ‚Üí go to Step 5 (FINAL OUTPUT).\n   - If the user says \"No\" ‚Üí ask what to fix, update data, and confirm again.\n\n# FINAL OUTPUT & DATA FORMAT\n1. DURING CONVERSATION (While collecting data):\n   - Only normal dialogue. NO JSON. Do not mention JSON, system output, or technical data.\n2. ONLY WHEN FINISHED (Only after the user confirmed \"Yes/Correct\"):\n   - Output MUST contain exactly ONE code block with valid JSON.\n   - No text before or after the JSON.\n\nExample of the final output format:\n```json\n{\n  \"is_finished\": true,\n  \"sex\": \"male\",\n  \"weight\": 85,\n  \"height\": 182,\n  \"age\": 30,\n  \"activity_level\": \"moderate\",\n  \"goal\": \"weight_loss\",\n  \"allergies\": \"none\",\n  \"excluded_foods\": \"fish\"\n}\n- ‚ÄúReturn meal names and dish names in the same language as the user's last message‚Äù"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -2208,
        144
      ],
      "id": "1ccda40f-b714-4dda-b2bd-a3349755941c",
      "name": "AGENT MAIN"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d629d6d4-e486-4d35-a824-d1440cfc4e97",
              "name": "text",
              "value": "={{ $('formating').item.json.message_text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2464,
        144
      ],
      "id": "12951a94-b371-40c6-89ca-90ac99829845",
      "name": "text"
    },
    {
      "parameters": {
        "jsCode": "// 1. –î–∞–Ω–Ω—ã–µ –æ—Ç –ê–≥–µ–Ω—Ç–∞ (–≤–µ—Å, —Ä–æ—Å—Ç, —Ü–µ–ª—å –∏ —Ç.–¥.)\nconst agentData = $input.first().json;\n\n// 2. –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (ID, username) –∏–∑ –Ω–æ–¥—ã 'formating'\nconst userData = $('formating').first().json;\n\n// --- –í–∞–ª–∏–¥–∞—Ü–∏—è —á–∏—Å–µ–ª (—á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–≤–∏—Ç—å NaN –∏ –Ω–µ –ø–∏—Å–∞—Ç—å –º—É—Å–æ—Ä –≤ –ë–î) ---\nconst weight = Number(agentData.weight);\nconst height = Number(agentData.height);\nconst age = Number(agentData.age);\n\nif (!Number.isFinite(weight) || weight <= 0) throw new Error(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–µ—Å: ${agentData.weight}`);\nif (!Number.isFinite(height) || height <= 0) throw new Error(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–æ—Å—Ç: ${agentData.height}`);\nif (!Number.isFinite(age) || age <= 0) throw new Error(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç: ${agentData.age}`);\n\n// 3. –§–æ—Ä–º—É–ª–∞ –ú–∏—Ñ—Ñ–ª–∏–Ω–∞-–°–∞–Ω –ñ–µ–æ—Ä–∞\nconst isMale = (agentData.sex === 'male' || agentData.sex === '–º');\n\nlet bmr;\nif (isMale) {\n  bmr = 10 * weight + 6.25 * height - 5 * age + 5;\n} else {\n  bmr = 10 * weight + 6.25 * height - 5 * age - 161;\n}\n\n// 4. –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\nconst activityMap = {\n  sedentary: 1.2,\n  light: 1.375,\n  moderate: 1.55,\n  high: 1.725,\n  extreme: 1.9\n};\n\nconst multiplier = activityMap[agentData.activity_level] || 1.375;\nconst tdee = bmr * multiplier;\n\n// 5. –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –ø–æ–¥ —Ü–µ–ª—å (–∫–∞–ª–æ—Ä–∏–∏)\nlet targetCalories = tdee;\n\nif (agentData.goal === 'weight_loss') {\n  targetCalories *= 0.85;\n} else if (agentData.goal === 'muscle_gain') {\n  targetCalories *= 1.10;\n}\n\n// 6. –†–∞—Å—á–µ—Ç –ë–ñ–£ (–ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê)\n// –ñ–ò–†–´: 1 –≥ / –∫–≥ (—Ñ–∏–∫—Å)\nconst fatG = weight * 1.0;\nconst fatCals = fatG * 9;\n\n// –ë–ï–õ–û–ö: 1.3‚Äì1.5 –≥ / –∫–≥\n// –í—ã–±–∏—Ä–∞–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–æ —Ü–µ–ª–∏, –Ω–æ —Å—Ç—Ä–æ–≥–æ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ.\nlet proteinCoeff = 1.4; // maintenance –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\n\nif (agentData.goal === 'weight_loss') proteinCoeff = 1.5;\nelse if (agentData.goal === 'muscle_gain') proteinCoeff = 1.5;\nelse proteinCoeff = 1.4;\n\n// clamp 1.3..1.5\nproteinCoeff = Math.max(1.3, Math.min(1.5, proteinCoeff));\n\nconst proteinG = weight * proteinCoeff;\nconst proteinCals = proteinG * 4;\n\n// –£–ì–õ–ï–í–û–î–´: –æ—Å—Ç–∞—Ç–æ–∫ –∫–∞–ª–æ—Ä–∏–π\nlet carbCals = targetCalories - proteinCals - fatCals;\n\n// –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö —É–≥–ª–µ–π (–µ—Å–ª–∏ –∫–∞–ª–æ—Ä–∏–∏ –Ω–∏–∑–∫–∏–µ, –∞ –∂–∏—Ä—ã/–±–µ–ª–æ–∫ —Å—ä–µ–ª–∏ –≤—Å—ë)\nif (carbCals < 0) carbCals = 0;\n\nconst carbG = carbCals / 4;\n\n// 7. –§–ò–ù–ê–õ–¨–ù–´–ô –í–´–í–û–î (–ü–ª–æ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è SQL)\nreturn {\n  json: {\n    chat_id: userData.chat_id,\n    username: userData.username,\n\n    sex: agentData.sex,\n    age,\n    weight,\n    height,\n    activity_level: agentData.activity_level,\n    goal: agentData.goal,\n    allergies: agentData.allergies || \"–Ω–µ—Ç\",\n    excluded_foods: agentData.excluded_foods || \"–Ω–µ—Ç\",\n\n    macros: {\n      calories: Math.round(targetCalories),\n      protein: Math.round(proteinG),\n      fats: Math.round(fatG),\n      carbs: Math.round(carbG)\n    },\n\n    calories: Math.round(targetCalories),\n    protein: Math.round(proteinG),\n    fats: Math.round(fatG),\n    carbs: Math.round(carbG)\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1552,
        256
      ],
      "id": "d15e55c2-54e1-4145-a475-00835e4f8801",
      "name": "calculator macros"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=–°–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è –Ω–∞ –¥–µ–Ω—å, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –ö–ë–ñ–£ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö, —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.\n",
        "options": {
          "systemMessage": "=# ROLE\n–¢—ã ‚Äî –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥-—Ç–µ—Ö–Ω–æ–ª–æ–≥. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ—Å—Ç–∞–≤–∏—Ç—å –º–µ–Ω—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.\n\n# INPUT DATA\n–¶–µ–ª—å: {{ $('calculator macros').item.json.macros.calories }} –∫–∫–∞–ª\n–ë–µ–ª–∫–∏: {{ $('calculator macros').item.json.macros.protein }}\n–ñ–∏—Ä—ã: {{ $('calculator macros').item.json.macros.fats }}\n–£–≥–ª–µ–≤–æ–¥—ã: {{ $('calculator macros').item.json.macros.carbs }}\n–ò—Å–∫–ª—é—á–∏—Ç—å: {{ $('calculator macros').item.json.excluded_foods }}\n–ê–ª–ª–µ—Ä–≥–∏–∏: {{ $('calculator macros').item.json.allergies }}\n\n# STRICT RULES\n1. –í—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON.\n2. –ï—Å–ª–∏ –≤ \"–ò—Å–∫–ª—é—á–∏—Ç—å\" –∏–ª–∏ \"–ê–ª–ª–µ—Ä–≥–∏–∏\" –µ—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç, –æ–Ω –°–¢–†–û–ì–û –∑–∞–ø—Ä–µ—â–µ–Ω –≤–æ –≤—Å–µ—Ö –±–ª—é–¥–∞—Ö.\n\n# INSTRUCTIONS\n1. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞:** –°–¢–†–û–ì–û 3 –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏: –ó–∞–≤—Ç—Ä–∞–∫, –û–±–µ–¥, –£–∂–∏–Ω.\n2. **–ó–∞–ø—Ä–µ—Ç:** –ù–ò–ö–ê–ö–ò–• –ø–µ—Ä–µ–∫—É—Å–æ–≤, –ø–æ–ª–¥–Ω–∏–∫–æ–≤ –∏–ª–∏ –≤—Ç–æ—Ä—ã—Ö –∑–∞–≤—Ç—Ä–∞–∫–æ–≤. –î–∞–∂–µ –µ—Å–ª–∏ –∫–∞–ª–æ—Ä–∏–π –æ—á–µ–Ω—å –º–Ω–æ–≥–æ (3000+), —É–≤–µ–ª–∏—á–∏–≤–∞–π –ø–æ—Ä—Ü–∏–∏ –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö –±–ª—é–¥–∞—Ö, –Ω–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–π –Ω–æ–≤—ã–µ –ø—Ä–∏–µ–º—ã –ø–∏—â–∏.\n3. **–ê–¥–∞–ø—Ç–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ–¥—É–∫—Ç—ã, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤ –º–∞—Å—Å-–º–∞—Ä–∫–µ—Ç–µ.\n4. **–§–∏–ª—å—Ç—Ä:** –ò—Å–∫–ª—é—á–∏ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã –∏ –Ω–µ–ª—é–±–∏–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (–∏–∑ —Å–ø–∏—Å–∫–∞ INPUT DATA).\n\n# OUTPUT JSON FORMAT\n{\n  \"meals\": [\n    {\n      \"name\": \"–ó–∞–≤—Ç—Ä–∞–∫\",\n      \"dish\": \"–û–º–ª–µ—Ç\",\n      \"ingredients\": [\n        // –í–ê–ñ–ù–û: –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã ‚Äî —ç—Ç–æ –º–∞—Å—Å–∏–≤ –û–ë–™–ï–ö–¢–û–í, –∞ –Ω–µ —Å—Ç—Ä–æ–∫!\n        {\"name\": \"–Ø–π—Ü–æ\", \"weight_g\": 100, \"cals\": 150, \"p\": 12, \"f\": 10, \"c\": 1},\n        {\"name\": \"–ú–æ–ª–æ–∫–æ\", \"weight_g\": 50, \"cals\": 30, \"p\": 1, \"f\": 1, \"c\": 2}\n      ],\n      \"total_cals\": 180\n    }\n    // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∏–µ–º—ã\n  ]\n}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -1040,
        256
      ],
      "id": "17576549-15be-4cee-ab5a-c8e7c69c61d8",
      "name": "AGENT FOOD"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').first().json.message.from.id }}",
        "text": "={{ $json.final_message }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -416,
        256
      ],
      "id": "5fb208c6-5a15-4de9-9e36-aca9183011d6",
      "name": "message for AGENT FOOD",
      "webhookId": "65a646d3-c60b-41c6-a48c-8efa6dff8b49",
      "credentials": {
        "telegramApi": {
          "id": "MC57N6YjUFPSjXve",
          "name": "bot_ivan"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "=<b>RU:</b>\n–ü—Ä–∏–Ω—è–ª! –°—á–∏—Ç–∞—é —Ç–≤–æ–∏ –∫–∞–ª–æ—Ä–∏–∏ –∏ –ø–æ–¥–±–∏—Ä–∞—é –º–µ–Ω—é –∏–∑ –±–∞–∑—ã, –ø–æ–¥–æ–∂–¥–∏ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥...\n\n<b>EN:</b>\nGot it! Calculating your calories and selecting a menu from the database, please wait a few seconds...\n\n<b>AR:</b>\nÿ™ŸÖ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ! ÿ¨ÿßÿ±Ÿä ÿ≠ÿ≥ÿßÿ® ÿ≥ÿπÿ±ÿßÿ™ŸÉ ÿßŸÑÿ≠ÿ±ÿßÿ±Ÿäÿ© ŸàÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ÿ∂ÿπ ÿ´ŸàÿßŸÜŸç...",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1216,
        256
      ],
      "id": "97a24003-60b3-43f1-bd92-a1c9a3ce7b19",
      "name": "messge for ready diets",
      "webhookId": "853b08df-d614-4a7c-90a2-a3cd378a00f0",
      "credentials": {
        "telegramApi": {
          "id": "MC57N6YjUFPSjXve",
          "name": "bot_ivan"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM users_nutrition WHERE chat_id = {{ $json.message.chat.id }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3904,
        272
      ],
      "id": "fa29b494-1380-445b-9811-aedcf79d40e6",
      "name": "get db user",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "lPu7MlAT3plm2aFH",
          "name": "railway postgre"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "20737ee4-1d4c-496c-b9ed-e3344f954761",
              "leftValue": "={{ $json.get_food }}",
              "rightValue": "True",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3696,
        272
      ],
      "id": "32a12021-126b-45c1-b43c-286489bf8d52",
      "name": "If1"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').first().json.message.from.id }}",
        "text": "<b>RU:</b>\n–ß–µ–º–ø–∏–æ–Ω, –∏–∑–≤–∏–Ω–∏. –Ø –Ω–µ –º–æ–≥—É –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ —Ç–µ–±–µ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –ö–ë–ñ–£.\n\n<b>EN:</b>\nChampion, I'm sorry. I cannot calculate your macros a second time.\n\n<b>AR:</b>\nÿ®ÿ∑ŸÑÿå ÿßÿπÿ™ÿ∞ÿ± ŸÖŸÜŸÉ. ŸÑÿß ŸäŸÖŸÉŸÜŸÜŸä ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≥ÿπÿ±ÿßÿ™ ŸàÿßŸÑŸÖÿßŸÉÿ±Ÿàÿ≤ ŸÑŸÉ ŸÖÿ±ÿ© ÿ´ÿßŸÜŸäÿ©..",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3488,
        128
      ],
      "id": "ad8487be-5f64-494e-958d-9e7a5a36075d",
      "name": "text message",
      "webhookId": "f1fa3c03-201a-405e-82cf-5f9808fd2132",
      "credentials": {
        "telegramApi": {
          "id": "MC57N6YjUFPSjXve",
          "name": "bot_ivan"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO users_nutrition (\n    chat_id, username, sex, age, weight, height, \n    activity_level, goal, allergies, excluded_foods,\n    calories, protein, fats, carbs, language, updated_at\n) VALUES (\n    {{ $json.chat_id }}, \n    '{{ $json.username }}', \n    '{{ $json.sex }}', \n    {{ $json.age }}, \n    {{ $json.weight }}, \n    {{ $json.height }}, \n    '{{ $json.activity_level }}', \n    '{{ $json.goal }}', \n    '{{ $json.allergies }}', \n    '{{ $json.excluded_foods }}',\n    {{ $json.calories }}, \n    {{ $json.protein }}, \n    {{ $json.fats }}, \n    {{ $json.carbs }},\n    '{{ $('formating').first().json.language }}',\n    NOW()\n)\nON CONFLICT (chat_id) DO UPDATE SET \n    sex = EXCLUDED.sex,\n    weight = EXCLUDED.weight,\n    calories = EXCLUDED.calories,\n    protein = EXCLUDED.protein,\n    fats = EXCLUDED.fats,\n    carbs = EXCLUDED.carbs,\n    language = EXCLUDED.language,\n    get_food = FALSE, \n    updated_at = NOW();",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1392,
        256
      ],
      "id": "77c3dee4-bdb3-42a6-9a78-0c0ac3394d1c",
      "name": "save data user db",
      "credentials": {
        "postgres": {
          "id": "lPu7MlAT3plm2aFH",
          "name": "railway postgre"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE users_nutrition \nSET \n  get_food = TRUE,\n  funnel_stage = 0,       -- –Ø–≤–Ω–æ —Å—Ç–∞–≤–∏–º 0\n  last_funnel_msg_at = NOW() -- –≠—Ç–æ –±—É–¥–µ—Ç —Ç–æ—á–∫–∞ –æ—Ç—Å—á–µ—Ç–∞\nWHERE chat_id = {{ $('formating').first().json.user_id }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -256,
        256
      ],
      "id": "c03f9e0d-3794-42ee-9827-79a26c0280e6",
      "name": "get_food = True",
      "credentials": {
        "postgres": {
          "id": "lPu7MlAT3plm2aFH",
          "name": "railway postgre"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–•\nconst agentResponse = $input.first().json.output; \n// –î–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ (—Ü–µ–ª–∏)\nconst clientData = $('calculator macros').first().json;\nconst targets = clientData.macros || {}; // { calories, protein, fats, carbs }\n\nlet parsedMenu = null;\nlet validationError = null;\n\n// --- –§–£–ù–ö–¶–ò–ò ---\n\nfunction cleanJson(text) {\n  const match = text.match(/\\{[\\s\\S]*\\}/);\n  return match ? match[0] : text;\n}\n\nfunction normalize(str) {\n  return str ? str.toLowerCase().trim() : \"\";\n}\n\n// --- –õ–û–ì–ò–ö–ê ---\n\n// –°—á–µ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π\nlet totalStats = {\n  cals: 0,\n  p: 0,\n  f: 0,\n  c: 0\n};\n\ntry {\n  // 1. –ü–∞—Ä—Å–∏–Ω–≥\n  const jsonString = cleanJson(agentResponse);\n  parsedMenu = JSON.parse(jsonString);\n\n  // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∫—É\n  const forbiddenList = [\n    ...normalize(clientData.excluded_foods).split(/,|;/),\n    ...normalize(clientData.allergies).split(/,|;/)\n  ].filter(i => i.length > 2);\n\n  let foundForbidden = [];\n  \n  if (parsedMenu.meals && Array.isArray(parsedMenu.meals)) {\n    parsedMenu.meals.forEach(meal => {\n      if (meal.ingredients) {\n        meal.ingredients.forEach(ing => {\n          const ingName = normalize(ing.name);\n          \n          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∫–∏\n          forbiddenList.forEach(badWord => {\n            if (ingName.includes(badWord)) {\n              foundForbidden.push(`${ing.name} (—Å–æ–¥–µ—Ä–∂–∏—Ç \"${badWord}\")`);\n            }\n          });\n\n          // 3. –°–£–ú–ú–ò–†–û–í–ê–ù–ò–ï –ë–ñ–£ (–í–∞–∂–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ)\n          // –ò—Å–ø–æ–ª—å–∑—É–µ–º || 0, —á—Ç–æ–±—ã –∫–æ–¥ –Ω–µ –ø–∞–¥–∞–ª, –µ—Å–ª–∏ –ò–ò –∑–∞–±—ã–ª –ø–æ–ª–µ\n          totalStats.cals += Number(ing.cals) || 0;\n          totalStats.p    += Number(ing.p) || 0;\n          totalStats.f    += Number(ing.f) || 0;\n          totalStats.c    += Number(ing.c) || 0;\n        });\n      }\n    });\n  }\n\n  if (foundForbidden.length > 0) {\n    throw new Error(`–í –º–µ–Ω—é –ø–æ–ø–∞–ª–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã: ${foundForbidden.join(\", \")}`);\n  }\n\n  // 4. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏ (–ü–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å 10%)\n  // –ú—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–∞–≤–Ω–æ–µ - –∫–∞–ª–æ—Ä–∏–∏. –ë–ñ–£ –º–æ–≥—É—Ç –ø–ª–∞–≤–∞—Ç—å —Å–∏–ª—å–Ω–µ–µ, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.\n  const targetCals = targets.calories || 2000;\n  const tolerance = 0.10; \n  const diff = Math.abs(totalStats.cals - targetCals);\n  \n  if (diff > (targetCals * tolerance)) {\n     throw new Error(`–ö–∞–ª–æ—Ä–∞–∂ –º–∏–º–æ –∫–∞—Å—Å—ã. –¶–µ–ª—å: ${targetCals}, –í—ã—à–ª–æ: ${Math.round(totalStats.cals)}`);\n  }\n\n} catch (error) {\n  validationError = error.message;\n}\n\n// --- –í–´–í–û–î ---\n\nreturn {\n  json: {\n    is_valid: (parsedMenu !== null && validationError === null),\n    error_reason: validationError,\n    \n    // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ–Ω—é –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞\n    menu_data: parsedMenu,\n    \n    // –§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å—á–∏—Ç–∞–Ω–Ω—ã–µ —Ü–∏—Ñ—Ä—ã (–æ–∫—Ä—É–≥–ª—è–µ–º –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã)\n    calculated_stats: {\n        calories: Math.round(totalStats.cals),\n        protein: Math.round(totalStats.p),\n        fats: Math.round(totalStats.f),\n        carbs: Math.round(totalStats.c)\n    },\n    \n    // –¶–µ–ª–µ–≤—ã–µ —Ü–∏—Ñ—Ä—ã (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ)\n    target_stats: {\n        calories: targets.calories,\n        protein: targets.protein,\n        fats: targets.fats,\n        carbs: targets.carbs\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -736,
        256
      ],
      "id": "c4a3e66f-c215-4c46-b6ee-a38cd7c77293",
      "name": "output -> json"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ\nconst input = $input.first().json;\n// –ï—Å–ª–∏ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É, –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –ª–µ–∂–∞—Ç—å –≥–ª—É–±–∂–µ –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∏—Ç–∞—è\n// –ù–æ –º—ã –ø–æ—Å—Ç–∞—Ä–∞–µ–º—Å—è –≤—ã–≤–µ—Å—Ç–∏ —Ö–æ—Ç—å —á—Ç–æ-—Ç–æ\nconst menu = input.menu_data || {};\nconst stats = input.calculated_stats || { calories: 0, protein: 0, fats: 0, carbs: 0 };\nconst targets = input.target_stats || { calories: 0, protein: 0, fats: 0, carbs: 0 };\n\nconst fmt = (num) => Math.round(num || 0);\n\n// 1. –®–ê–ü–ö–ê\nlet msg = `<b>üí™ –ü–õ–ê–ù –ü–ò–¢–ê–ù–ò–Ø –ì–û–¢–û–í!</b>\\n\\n`;\n\n// –ï—Å–ª–∏ –∫–∞–ª–æ—Ä–∏–∏ 0 (–æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏), –ø–∏—à–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤—ã–≤–æ–¥–∏–º —á—Ç–æ –µ—Å—Ç—å\nif (stats.calories === 0 && input.is_valid === false) {\n    msg += `‚ö†Ô∏è <i>(–ê–≤—Ç–æ-–ø–æ–¥—Å—á–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –Ω–æ –≤–æ—Ç —Ç–≤–æ–µ –º–µ–Ω—é)</i>\\n\\n`;\n} else {\n    msg += `<b>üìä –ò–¢–û–ì–û –ó–ê –î–ï–ù–¨:</b>\\n`;\n    msg += `üî• <b>${fmt(stats.calories)} –∫–∫–∞–ª</b> (–¶–µ–ª—å: ${fmt(targets.calories)})\\n`;\n    msg += `ü•© –ë–µ–ª–∫–∏: ${fmt(stats.protein)}–≥ / ${fmt(targets.protein)}–≥\\n`;\n    msg += `ü•ë –ñ–∏—Ä—ã: ${fmt(stats.fats)}–≥ / ${fmt(targets.fats)}–≥\\n`;\n    msg += `üçö –£–≥–ª–∏:  ${fmt(stats.carbs)}–≥ / ${fmt(targets.carbs)}–≥\\n`;\n    msg += `__________________________________\\n\\n`;\n}\n\n// 2. –°–ü–ò–°–û–ö –ë–õ–Æ–î\nif (menu.meals && Array.isArray(menu.meals)) {\n    menu.meals.forEach((meal) => {\n        let icon = 'üçΩ';\n        const nameLower = (meal.name || \"\").toLowerCase();\n        if (nameLower.includes('–∑–∞–≤—Ç—Ä–∞–∫')) icon = 'üç≥';\n        if (nameLower.includes('–æ–±–µ–¥')) icon = 'üç≤';\n        if (nameLower.includes('—É–∂–∏–Ω')) icon = 'ü•ó';\n        \n        msg += `${icon} <b>${(meal.name || \"–ü—Ä–∏–µ–º –ø–∏—â–∏\").toUpperCase()}</b>\\n`;\n        msg += `<i>${meal.dish || \"\"}</i>\\n`; \n        \n        // –£–ú–ù–´–ô –†–ï–ù–î–ï–† –ò–ù–ì–†–ï–î–ò–ï–ù–¢–û–í\n        if (meal.ingredients && Array.isArray(meal.ingredients)) {\n            meal.ingredients.forEach(ing => {\n                // –ü–†–û–í–ï–†–ö–ê: –≠—Ç–æ —Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ –æ–±—ä–µ–∫—Ç?\n                if (typeof ing === 'string') {\n                    // –ï—Å–ª–∏ –∞–≥–µ–Ω—Ç –ø—Ä–∏—Å–ª–∞–ª —Å—Ç—Ä–æ–∫—É: \"–¢–≤–æ—Ä–æ–≥ - 200–≥\"\n                    msg += `‚ñ´Ô∏è ${ing}\\n`;\n                } else {\n                    // –ï—Å–ª–∏ –∞–≥–µ–Ω—Ç –ø—Ä–∏—Å–ª–∞–ª –æ–±—ä–µ–∫—Ç (–∫–∞–∫ –Ω–∞–¥–æ)\n                    msg += `‚ñ´Ô∏è ${ing.name}: <b>${ing.weight_g}–≥</b>\\n`;\n                }\n            });\n        }\n\n        const mealCals = Math.round(meal.total_cals || 0);\n        if (mealCals > 0) msg += `‚îî <i>~${mealCals} –∫–∫–∞–ª</i>\\n\\n`;\n        else msg += `\\n`;\n    });\n}\n\nmsg += `<i>–°–æ—Ö—Ä–∞–Ω—è–π, –≥–æ—Ç–æ–≤—å –∏ —Å—Ç–∞–Ω–æ–≤–∏—Å—å –ª—É—á—à–µ! üöÄ</i>`;\n\nreturn {\n  json: {\n    final_message: msg,\n    chat_id: input.chat_id || $('Telegram Trigger').first().json.message?.chat?.id \n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -576,
        256
      ],
      "id": "58529e40-28e3-42ef-a540-9abd62285f82",
      "name": "comver to HTML"
    },
    {
      "parameters": {
        "jsCode": "// 1. –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –ê–≥–µ–Ω—Ç–∞\nconst agentOutput = $input.first().json.output || \"\";\n\nlet parsedData = null;\nlet isReadyToGenerate = false;\nlet cleanText = agentOutput; \n\n// --- –§–£–ù–ö–¶–ò–ò –ü–û–ò–°–ö–ê –ò –û–ß–ò–°–¢–ö–ò ---\n\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON\nfunction tryParseJSON(str) {\n    try {\n        return JSON.parse(str);\n    } catch (e) {\n        return null;\n    }\n}\n\n// 2. –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ JSON –≤–Ω—É—Ç—Ä–∏ –æ—Ç–≤–µ—Ç–∞\n// –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º JSON –≤ –±–ª–æ–∫–∞—Ö –∫–æ–¥–∞ ```json ... ``` (—ç—Ç–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)\nlet jsonMatch = agentOutput.match(/```json\\s*(\\{[\\s\\S]*?\\})\\s*```/i);\n\n// –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –±–ª–æ–∫–∞—Ö, –∏—â–µ–º –ø—Ä–æ—Å—Ç–æ —Ñ–∏–≥—É—Ä–Ω—ã–µ —Å–∫–æ–±–∫–∏ (–∂–∞–¥–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞)\nif (!jsonMatch) {\n    jsonMatch = agentOutput.match(/(\\{[\\s\\S]*\\})/);\n}\n\nif (jsonMatch) {\n    const jsonString = jsonMatch[1] || jsonMatch[0]; // –ë–µ—Ä–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç\n    const fullMatch = jsonMatch[0]; // –ë–µ—Ä–µ–º –≤–µ—Å—å –Ω–∞–π–¥–µ–Ω–Ω—ã–π –∫—É—Å–æ–∫ (–≤–∫–ª—é—á–∞—è ```)\n\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∞–ª–∏–¥–Ω—ã–π –ª–∏ —ç—Ç–æ JSON\n    const data = tryParseJSON(jsonString);\n    \n    if (data) {\n        parsedData = data;\n        \n        // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è\n        if (parsedData.is_finished === true) {\n            isReadyToGenerate = true;\n        }\n\n        // –ê–ì–†–ï–°–°–ò–í–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –¢–ï–ö–°–¢–ê\n        // 1. –£–¥–∞–ª—è–µ–º —Å–∞–º JSON (–∏ –∫–æ–¥-–±–ª–æ–∫–∏, –µ—Å–ª–∏ –±—ã–ª–∏)\n        cleanText = cleanText.replace(fullMatch, '');\n        \n        // 2. –£–¥–∞–ª—è–µ–º \"–º—É—Å–æ—Ä–Ω—ã–µ\" —Ñ—Ä–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –æ—Å—Ç–∞—é—Ç—Å—è –ø–µ—Ä–µ–¥ JSON\n        // –ù–∞–ø—Ä–∏–º–µ—Ä: \"–í–æ—Ç –¥–∞–Ω–Ω—ã–µ:\", \"JSON output:\", \"Output:\"\n        const garbagePhrases = [\n            /Here is the JSON:?/yi,\n            /JSON output:?/yi,\n            /System output:?/yi,\n            /–í–æ—Ç json:?/yi,\n            /–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ:?/yi\n        ];\n        \n        garbagePhrases.forEach(regex => {\n            cleanText = cleanText.replace(regex, '');\n        });\n    }\n}\n\n// –§–∏–Ω–∞–ª—å–Ω–∞—è –∑–∞—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–±–µ–ª–æ–≤\ncleanText = cleanText.trim();\n\n// –ï—Å–ª–∏ –ø–æ—Å–ª–µ –∑–∞—á–∏—Å—Ç–∫–∏ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π (–∞–≥–µ–Ω—Ç –ø—Ä–∏—Å–ª–∞–ª —Ç–æ–ª—å–∫–æ JSON), \n// –Ω–æ –º—ã –µ—â–µ –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª–∏ (is_finished: false), —Å—Ç–∞–≤–∏–º –∑–∞–≥–ª—É—à–∫—É, —á—Ç–æ–±—ã –Ω–µ —Å–ª–∞—Ç—å –ø—É—Å—Ç–æ—Ç—É\nif (!cleanText && !isReadyToGenerate) {\n    // –û–±—ã—á–Ω–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –∞–≥–µ–Ω—Ç —Ç—É–ø–∏—Ç. –ú–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –ø—É—Å—Ç–æ—Ç—É, \n    // –Ω–æ –ª—É—á—à–µ –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å, –µ—Å–ª–∏ –ª–æ–≥–∏–∫–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç.\n    // –í –≤–∞—à–µ–º —Å–ª—É—á–∞–µ –æ—Å—Ç–∞–≤–∏–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, Telegram –º–æ–∂–µ—Ç –≤—ã–¥–∞—Ç—å –æ—à–∏–±–∫—É, \n    // –ø–æ—ç—Ç–æ–º—É –¥–æ–±–∞–≤–∏–º —ç–º–æ–¥–∑–∏ –∏–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏–º.\n    cleanText = \"‚è≥\"; \n}\n\n// 3. –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∏ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ HTML\nif (isReadyToGenerate) {\n    // –í–ï–¢–ö–ê 1: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è\n    return {\n        json: {\n            ...parsedData,\n            route_type: 'generate'\n        }\n    };\n} else {\n    // –í–ï–¢–ö–ê 2: –†–∞–∑–≥–æ–≤–æ—Ä\n    \n    let processedText = cleanText;\n\n    // --- –ü–†–ï–í–†–ê–©–ï–ù–ò–ï MARKDOWN –í HTML ---\n    // 1. –ñ–∏—Ä–Ω—ã–π: **—Ç–µ–∫—Å—Ç** -> <b>—Ç–µ–∫—Å—Ç</b>\n    processedText = processedText.replace(/\\*\\*(.*?)\\*\\*/g, '<b>$1</b>');\n    \n    // 2. –ñ–∏—Ä–Ω—ã–π: __—Ç–µ–∫—Å—Ç__ -> <b>—Ç–µ–∫—Å—Ç</b>\n    processedText = processedText.replace(/__(.*?)__/g, '<b>$1</b>');\n\n    // 3. –°–ø–∏—Å–∫–∏: * –ø—É–Ω–∫—Ç -> ‚Ä¢ –ø—É–Ω–∫—Ç\n    processedText = processedText.replace(/^\\*\\s/gm, '‚Ä¢ ');\n\n    // 4. –ö—É—Ä—Å–∏–≤: *—Ç–µ–∫—Å—Ç* -> <i>—Ç–µ–∫—Å—Ç</i> (–∞–∫–∫—É—Ä–∞—Ç–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –∑–∞–¥–µ—Ç—å —Å–ø–∏—Å–∫–∏)\n    processedText = processedText.replace(/([^*])\\*([^*]+)\\*([^*])/g, '$1<i>$2</i>$3');\n\n    // 5. –ó–∞–≥–æ–ª–æ–≤–∫–∏: ### -> <b>\n    processedText = processedText.replace(/^#{1,6}\\s+(.*)$/gm, '<b>$1</b>');\n\n    return {\n        json: {\n            text_response: processedText, \n            route_type: 'conversation'\n        }\n    };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1936,
        144
      ],
      "id": "e675a152-541d-4fba-8cce-6a039fb1c445",
      "name": "new_formater"
    },
    {
      "parameters": {
        "model": "google/gemini-3-flash-preview",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -2224,
        304
      ],
      "id": "c4c3a64d-25ed-44a9-9e2a-17962176f4ac",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "VEeJdAgWAIzKltob",
          "name": "mxpkns"
        }
      }
    },
    {
      "parameters": {
        "model": "google/gemini-3-flash-preview",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -1040,
        432
      ],
      "id": "9d9b62aa-3648-4465-9777-8c0b611a4e0c",
      "name": "OpenRouter Chat Model1",
      "credentials": {
        "openRouterApi": {
          "id": "VEeJdAgWAIzKltob",
          "name": "mxpkns"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const status = $input.first().json?.result?.status;\nconst allowed = ['member', 'administrator', 'creator'];\nreturn [{ json: { is_subscribed: allowed.includes(status), status } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3248,
        464
      ],
      "id": "bf5cd467-c510-44a4-88db-be02f25c3ec4",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -2064,
        320
      ],
      "id": "cfb76040-f0e0-4b22-b122-cb6280b6cccc",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "lPu7MlAT3plm2aFH",
          "name": "railway postgre"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "message",
          "callback_query"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -4896,
        240
      ],
      "id": "70ca015c-1684-4f44-8b1e-0a71051eb86e",
      "name": "Telegram Trigger",
      "webhookId": "532c8fec-933b-439d-8565-df6bfc22263e",
      "credentials": {
        "telegramApi": {
          "id": "MC57N6YjUFPSjXve",
          "name": "bot_ivan"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "5f564d3f-5a5d-4143-9add-8352999cce8b",
              "leftValue": "={{ $json.callback_query }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -4672,
        240
      ],
      "id": "6870b789-d89a-4b16-9ef0-c9eaa87034df",
      "name": "If2"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "value": "public",
          "mode": "list",
          "cachedResultName": "public"
        },
        "table": {
          "__rl": true,
          "value": "users_nutrition",
          "mode": "list",
          "cachedResultName": "users_nutrition"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "chat_id",
              "value": "={{ $json.callback_query.message.chat.id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -4336,
        -272
      ],
      "id": "88d8bcbc-b85f-4918-8441-14b726403ae5",
      "name": "get language",
      "credentials": {
        "postgres": {
          "id": "lPu7MlAT3plm2aFH",
          "name": "railway postgre"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "B6QkQPsiMrigBfY4",
          "mode": "list",
          "cachedResultUrl": "/workflow/B6QkQPsiMrigBfY4",
          "cachedResultName": "callback_en"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "callback_query_data": "={{ $('If2').item.json.callback_query.data }}",
            "callback_query_message_chat_id": "={{ $('If2').item.json.callback_query.message.chat.id }}",
            "callback_query_id": "={{ $('If2').item.json.callback_query.id }}",
            "callback_query_from_id": "={{ $('If2').item.json.callback_query.from.id }}"
          },
          "matchingColumns": [
            "callback_query_data",
            "callback_query_message_chat_id",
            "callback_query_id",
            "callback_query_from_id"
          ],
          "schema": [
            {
              "id": "callback_query_data",
              "displayName": "callback_query_data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "callback_query_message_chat_id",
              "displayName": "callback_query_message_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "callback_query_id",
              "displayName": "callback_query_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "callback_query_from_id",
              "displayName": "callback_query_from_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        -3680,
        -304
      ],
      "name": "Call callback_en",
      "id": "50e41f44-be01-4ec2-ab0a-152fa0ebb207"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "2GGB7l9opUfOHgpo",
          "mode": "list",
          "cachedResultUrl": "/workflow/2GGB7l9opUfOHgpo",
          "cachedResultName": "callback_ru"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "callback_query_data": "={{ $('If2').item.json.callback_query.data }}",
            "callback_query_message_chat_id": "={{ $('If2').item.json.callback_query.message.chat.id }}",
            "callback_query_id": "={{ $('If2').item.json.callback_query.id }}"
          },
          "matchingColumns": [
            "callback_query_data",
            "callback_query_message_chat_id",
            "callback_query_id"
          ],
          "schema": [
            {
              "id": "callback_query_data",
              "displayName": "callback_query_data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "callback_query_message_chat_id",
              "displayName": "callback_query_message_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "callback_query_id",
              "displayName": "callback_query_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        -3680,
        -528
      ],
      "name": "Call callback_ru",
      "id": "e67130af-3fa0-45e2-82b4-dd6c3e00d3fc"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.language }}",
                    "rightValue": "ru",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "afbae3ed-7209-4541-a1e8-f2c19fda7622"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ru"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "d209e7ea-fc06-48ef-8825-2412b71f9b31",
                    "leftValue": "={{ $json.language }}",
                    "rightValue": "en",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "en"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "2e2f6539-3604-4858-9cb2-6a47ec59de1f",
                    "leftValue": "={{ $json.language }}",
                    "rightValue": "ar",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ar"
            }
          ]
        },
        "options": {
          "allMatchingOutputs": true
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -4176,
        -288
      ],
      "id": "c46a92c4-3bcf-4483-9854-fd45b216b44f",
      "name": "callback router"
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "users_nutrition",
          "mode": "list",
          "cachedResultName": "users_nutrition"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": 379336096,
            "language": "ar"
          },
          "matchingColumns": [
            "chat_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "username",
              "displayName": "username",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "first_name",
              "displayName": "first_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "sex",
              "displayName": "sex",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "age",
              "displayName": "age",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "weight",
              "displayName": "weight",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "height",
              "displayName": "height",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "activity_level",
              "displayName": "activity_level",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "goal",
              "displayName": "goal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "allergies",
              "displayName": "allergies",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "excluded_foods",
              "displayName": "excluded_foods",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "calories",
              "displayName": "calories",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "protein",
              "displayName": "protein",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "fats",
              "displayName": "fats",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "carbs",
              "displayName": "carbs",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "get_food",
              "displayName": "get_food",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "funnel_stage",
              "displayName": "funnel_stage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "funnel_start_at",
              "displayName": "funnel_start_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "last_funnel_msg_at",
              "displayName": "last_funnel_msg_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "is_buyer",
              "displayName": "is_buyer",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "language",
              "displayName": "language",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -5392,
        -1632
      ],
      "id": "1032fdc3-7c64-49ce-85b3-b2cb7fc2d11b",
      "name": "Update rows in a table",
      "credentials": {
        "postgres": {
          "id": "lPu7MlAT3plm2aFH",
          "name": "railway postgre"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "jlwgyCM5RPUxTBhG",
          "mode": "list",
          "cachedResultUrl": "/workflow/jlwgyCM5RPUxTBhG",
          "cachedResultName": "callback_ar"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "callback_query_data": "={{ $('If2').item.json.callback_query.data }}",
            "callback_query_message_chat_id": "={{ $('If2').item.json.callback_query.message.chat.id }}",
            "callback_query_id": "={{ $('If2').item.json.callback_query.id }}",
            "callback_query_from_id": "={{ $('If2').item.json.callback_query.from.id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "callback_query_data",
              "displayName": "callback_query_data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "callback_query_message_chat_id",
              "displayName": "callback_query_message_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "callback_query_id",
              "displayName": "callback_query_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "callback_query_from_id",
              "displayName": "callback_query_from_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -3680,
        -80
      ],
      "id": "f8971f47-17d3-4367-bc22-fa8cc4568ec2",
      "name": "Call 'callback_ar'"
    }
  ],
  "pinData": {},
  "connections": {
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "AGENT MAIN",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get a file": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "routher": {
      "main": [
        [
          {
            "node": "text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get a file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check follower": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "formating": {
      "main": [
        [
          {
            "node": "check follower",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "routher",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "message menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "message for AI agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "calculator macros",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AGENT MAIN": {
      "main": [
        [
          {
            "node": "new_formater",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "text": {
      "main": [
        [
          {
            "node": "AGENT MAIN",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "calculator macros": {
      "main": [
        [
          {
            "node": "save data user db",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AGENT FOOD": {
      "main": [
        [
          {
            "node": "output -> json",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messge for ready diets": {
      "main": [
        [
          {
            "node": "AGENT FOOD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get db user": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "text message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "formating",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "save data user db": {
      "main": [
        [
          {
            "node": "messge for ready diets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "message for AGENT FOOD": {
      "main": [
        [
          {
            "node": "get_food = True",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get_food = True": {
      "main": [
        []
      ]
    },
    "output -> json": {
      "main": [
        [
          {
            "node": "comver to HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "comver to HTML": {
      "main": [
        [
          {
            "node": "message for AGENT FOOD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "new_formater": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AGENT MAIN",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AGENT FOOD",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AGENT MAIN",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "get language",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get db user",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get language": {
      "main": [
        [
          {
            "node": "callback router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "callback router": {
      "main": [
        [
          {
            "node": "Call callback_ru",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Call callback_en",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Call 'callback_ar'",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "ff403465-6266-4177-ad2b-655dc839ad7b",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "45b562a72a8b99927a2de093265cde67bc0d3affac17a774ed22c79e357b2dae"
  },
  "id": "cXhW3Mu9WdRnk0Fe",
  "tags": [
    {
      "updatedAt": "2025-11-25T07:38:41.908Z",
      "createdAt": "2025-11-25T07:38:41.908Z",
      "id": "73Cgx5GNvxOjusRB",
      "name": "VANYA_BOT"
    }
  ]
}